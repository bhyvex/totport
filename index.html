<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>totport -- TOTP anywhere, any service</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style>
      body        { background: #fff; text-color: #000; margin-left:  40px;   font-size:  0.9em;  font-family: arial; }
  
      code        { font-size:    1.1em;  background:  #ddf; text-color: #000; }
      pre         { margin-left:  2em;    background:  #ddf; text-color: #000; }
      pre code    { font-size:    1.1em;  background:  #ddf; text-color: #000; }
  
      td          { vertical-align: top }
  
      .red        { color: red }
      .blue       { color: blue }
      .green      { color: green }
      .gray       { color: gray }
      .pink       { color: pink }
  
      .box        { background-color:#e0e0e0 }
      .bg-red     { background-color:#ffe0e0 }
      .bg-green   { background-color:#e0ffe0 }
      .bg-blue    { background-color:#e0e0ff }
  
      /* couldn't resist the name! */
      .wd40       { width: 40% !important }
  
      .box-l      { float: left;  padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-right: 4px; }
      .box-r      { float: right; padding: 0px 0.5em; background-color: #e0e0e0; width:25%; margin-left:  4px; }
  
      .fl-l       { float: left;  padding: 0px 0.5em;                                       margin-right: 4px; }
      .fl-r       { float: right; padding: 0px 0.5em;                                       margin-left:  4px; }
  
      .sidebar {
          margin-left: 4px;
          width: 25%;
          float: right;
          border: 4px solid #fff;
      }
  
  </style>
  <style>
      h1          { background: #ffb; text-color: #000; margin-left: -30px;   border-top:    5px  solid #ccc; }
      h2          { background: #ffb; text-color: #000; margin-left: -20px;   border-top:    3px  solid #ddd; }
      h3          { background: #ffb; text-color: #000; margin-left: -10px; }
      h4          { background: #ffb; text-color: #000; }
  </style>
</head>
<body>
<div id="header">
<h1 class="title">totport -- TOTP anywhere, any service</h1>
</div>
<div id="TOC">
<ul>
<li><a href="#teaser----what-do-users-see"><span class="toc-section-number">1</span> teaser -- what do users see?</a></li>
<li><a href="#quickstart"><span class="toc-section-number">2</span> quickstart</a><ul>
<li><a href="#install-and-setup"><span class="toc-section-number">2.1</span> install and setup</a></li>
<li><a href="#add-users"><span class="toc-section-number">2.2</span> add users</a></li>
</ul></li>
<li><a href="#details"><span class="toc-section-number">3</span> details</a><ul>
<li><a href="#token-validity-and-expiry"><span class="toc-section-number">3.1</span> token validity and expiry</a></li>
</ul></li>
<li><a href="#background"><span class="toc-section-number">4</span> background</a></li>
<li><a href="#security-notes"><span class="toc-section-number">5</span> SECURITY NOTES</a><ul>
<li><a href="#todo"><span class="toc-section-number">5.1</span> TODO</a></li>
</ul></li>
<li><a href="#appendices"><span class="toc-section-number">6</span> Appendices</a><ul>
<li><a href="#user-ssh-keys"><span class="toc-section-number">6.1</span> (user) ssh keys</a></li>
<li><a href="#user-securely-downloading-the-totp-secret"><span class="toc-section-number">6.2</span> (user) securely downloading the TOTP &quot;secret&quot;</a><ul>
<li><a href="#option-1-qr-code-server-on-the-totp-box"><span class="toc-section-number">6.2.1</span> option 1: qr code server on the TOTP box</a></li>
<li><a href="#option-2-qrencode-command"><span class="toc-section-number">6.2.2</span> option 2: qrencode command</a></li>
<li><a href="#option-3-type-it-in"><span class="toc-section-number">6.2.3</span> option 3: type it in!</a></li>
</ul></li>
<li><a href="#user-setting-up-ssh-config"><span class="toc-section-number">6.3</span> (user) setting up ssh config</a></li>
<li><a href="#user-putty"><span class="toc-section-number">6.4</span> (user) putty</a></li>
<li><a href="#admin-users-with-more-than-one-ssh-key"><span class="toc-section-number">6.5</span> (admin) users with more than one ssh key</a></li>
</ul></li>
</ul>
</div>
<script type="text/javascript">
<!--
    function hide_show(id) {
        var e = document.getElementById(id);
        if(e == null)
            return;
        if(e.style.display != 'none')
            e.style.display = 'none';
        else
            e.style.display = 'block';
    }

    window.onload = function() {
        var t = document.getElementById('TOC');
        var sbt = document.getElementById('SBTOC');
        var h = '<div id="PTOC">'
        var h2 = ''
        var h3 = '</div>'
        var h4 = '<div id="GTOC">'
        var h5 = '</div>'
        var hst = '<div style="background: white; color: green; border: 2px solid green"><center><font size=-1><strong>Hide/Show Table of Contents</strong><br />'
        var pd = '<a href="#" onclick="hide_show(\'PTOC\');">Page TOC</a></font></center></div>'
        var gt = ''

        if(t == null)
            sbt.innerHTML = hst + gt + h4 + sbt.innerHTML + h5;
        else {
            sbt.innerHTML = hst + pd + gt + h + h2 + t.innerHTML + h3 + h4 + sbt.innerHTML + h5;
            t.style.display = 'none';   // hide the TOC that pandoc placed
        }
    }
-->
</script>
<style>
    #PTOC ul {
        list-style: none;
        margin-left: 0;
        padding-left: 2em;
        text-indent: -2em;
        padding-bottom: 2em;
    }
    #PTOC ul li {
        padding-bottom: 10px;
    }
    #PTOC ul li ul {
        padding-bottom: 0px;
    }
    #PTOC ul li ul li {
        padding-bottom: 0px;
    }

    .sidebar-toc a:hover {
        background-color: white;
    }

    .sidebar-toc {
        margin-left: 4px;
        width: 25%;
        float: right;
        color: gray;
        background: lightgray;
        border: 4px solid #fff;
        font-size: 0.90em;
    }

    .sidebar-toc ul {
        padding-left: 2em;
    }

</style>
<div id="SBTOC" class="sidebar-toc">

</div>
<p><span class="box-r">Download: <a href="http://github.com/sitaramc/totport" class="uri">http://github.com/sitaramc/totport</a></span></p>
<p>TOTP (&quot;Time-based One Time Password&quot;) is the simplest way of adding &quot;2 factor authentication&quot; to a service. Many online services now offer TOTP as an additional security measure against stolen passwords. <span class="gray">Reference links: <a href="https://en.wikipedia.org/wiki/One-time_password">OTPs</a> are a type of <a href="https://en.wikipedia.org/wiki/Two_factor_authentication">two factor authentication</a>, and <a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">TOTPs</a> are a very specific type of OTP.</span></p>
<p>Sadly, most services are not TOTP enabled, or it requires a fair bit of effort to put a TOTP gate in front of them. (Think various imap servers, database servers, even web servers).</p>
<p><span class="box-r">The <code>totp</code> program which is part of <code>totport</code> can also be used as a TOTP backend for any application that can make system() calls. It has a very <a href="totp.html">simple but powerful API</a>.</span></p>
<p>But if you can force all your services to go through one &quot;gatekeeper&quot; server, (for example by telling the applications to accept connections <em>only</em> from the gatekeeper) then that server can use <strong>totport</strong> and authenticate users with TOTP, and then use ssh port forwarding to enable selective access. <span class="gray">One downside is that all the traffic goes through this server, so if huge chunks of data need to be moved, this may not be a good idea, but for most normal apps this is fine.</span></p>
<p><code>totport</code> works by creating an additional authorized keys line with appropriate &quot;from&quot; and &quot;permitopen&quot; options, when it receives a valid TOTP authcode. Subsequent connections from that validated IP address will permit forwarding to those hosts and ports.</p>
<p>The basic idea (of having a validate step making some kind of a backend change to enable the next action) is inspired by Konstantin's recent addition of <a href="https://github.com/mricon/totp-cgi/tree/master/contrib/gitolite">2-factor authentication</a> to <a href="http://gitolite.com">gitolite</a>. Thanks Konstantin!</p>
<p><span class="red">Of course, one downside of this very simple type of TOTP is that the user needs to have an Android phone or tab handy. While it is possible to compute the TOTP authcodes on the same laptop or desktop that the user is using to log on, this totally defeats the purpose of two factor authentication, so don't do that!</span></p>
<h1 id="teaser----what-do-users-see"><span class="header-section-number">1</span> teaser -- what do users see?</h1>
<p>Here's what the process of joining and using this system looks like to one of your users. We'll pretend your user is <a href="https://en.wikipedia.org/wiki/Alice_and_Bob">&quot;alice&quot;</a>.</p>
<p>First, the one-time enrollment:</p>
<div class="figure">
<img src="data:image/png;base64,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" />

</div>
<p><span class="gray">For the artistically challenged among you, the thing on the left is a laptop. If you don't get that, you'll never be able to appreciate Picasso's paintings either, so you may want to look into some art appreciation courses somewhere.</span></p>
<ol style="list-style-type: decimal">
<li><p>Alice sends you her ssh public key, plus a list of hosts (and corresponding ports) behind the TOTP gatekeeper that she wants access to.</p></li>
<li><p>You'll do some stuff on the server then tell her to &quot;enroll&quot;.</p></li>
<li><p>Alice runs &quot;ssh totport@host enroll&quot;, which enrolls her into the TOTP system. This means the server generates and prints out a secret that Alice must feed into the TOTP app (&quot;FreeOTP&quot; preferred, otherwise &quot;Google Authenticator&quot;) on her Android mobile or tab. More on this in one of the appendices.</p></li>
</ol>
<p>Next, the actual usage:</p>
<div class="figure">
<img src="data:image/png;base64,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" />

</div>
<ol style="list-style-type: decimal">
<li><p>When Alice wants to access any of the hosts behind the TOTP gatekeeper, she first sends a valid TOTP value, something like this:</p>
<pre><code>ssh totport@host val &lt;TOTP&gt;</code></pre>
<p>where the &quot;&lt;TOTP&gt;&quot; is of course whatever 6- or 8-digit number her TOTP software is currently displaying.</p>
<p>A message like <code>validated 'alice' from '1.2.3.4'</code> indicates success.</p></li>
<li><p>Once that is done, she enables the port forwards. This is done by connecting to the TOTP server again, but this time without any command. She runs the following in a spare terminal window and leaves it running:</p>
<pre><code>ssh -L 2222:1.2.3.4:22 -L 4433:2.3.4.5:443 totport@host</code></pre>
<p>(Later, she will probably set up her <code>~/.ssh/config</code> file to avoid typing so much! Details are in one of the appendices.)</p></li>
<li><p>At this point the local ports are ready. She uses the local port numbers she chose (2222, 4433, in the example above) with an IP of 127.0.0.1, and starts her clients, whatever they may be.</p></li>
</ol>
<h1 id="quickstart"><span class="header-section-number">2</span> quickstart</h1>
<h2 id="install-and-setup"><span class="header-section-number">2.1</span> install and setup</h2>
<p><strong>As root</strong>:</p>
<ul>
<li><p>Install perl's DBI driver and DBD::SQlite modules. On Fedora, the RPMs are called perl-DBI and perl-DBD-SQLite.</p>
<p>Running</p>
<pre><code>perl -MDBI -MDBD::SQLite -e 0</code></pre>
<p>should not show any errors.</p></li>
<li><p>Create a userid exclusively for this tool; in this documentation we will call it <code>totport</code>. Make sure no one has command line access to this userid from ssh. Instead, they should log on to some other userid on the server and run &quot;su - totport&quot;. If you have a password for this, make sure only the admin knows it and it is really long and complex and all that jazz.</p></li>
<li><p>Edit <code>/etc/ssh/sshd_config</code> and make sure you have the following settings.</p>
<p>In the main part of the file:</p>
<pre><code>AllowTCPForwarding no</code></pre>
<p>At the bottom of the file:</p>
<pre><code>Match User totport
    AllowTcpForwarding yes</code></pre>
<p>I'm not sure what is the minimum ssh version required for this, but most distros after 2012 or so should be fine.</p>
<p>Don't forget to restart sshd.</p></li>
</ul>
<p><strong>As the <code>totport</code> user</strong>:</p>
<ul>
<li><p>Run <code>mkdir bin; cd bin</code>, then get the following files into this directory:</p>
<pre><code># from http://github.com/sitaramc/totport
totp
totport
Utils.pm

# from http://github.com/sitaramc/hashlite
hashlite
HashLite.pm</code></pre>
<p>Don't forget to &quot;chmod +x&quot; the files that don't end in &quot;.pm&quot;.</p></li>
<li><p>Copy the sample rc file <code>t/totport.rc.sample</code> from totport (same URL as above) as <code>$HOME/totport.rc</code>.</p>
<p>Make whatever changes you need in this file; it's sufficiently commented.</p></li>
<li><p>Run <code>mkdir ~/keydir</code> to prepare for receiving user keys.</p></li>
<li><p>Run <code>qrserve</code> to start the qrcode display web server on port 3536.</p></li>
</ul>
<h2 id="add-users"><span class="header-section-number">2.2</span> add users</h2>
<ol style="list-style-type: decimal">
<li><p>Obtain public keys from your users and put them in <code>~/keydir</code>. The public key file for a user &quot;alice&quot; will be copied to <code>~/keydir/alice.pub</code>. Subdirectories are not allowed. If a user has more than one key they want to send you, please look in the appendices for how to deal with it.</p></li>
<li><p>Decide what ports the user should have access to (look in <code>~/totport.rc</code> for the short names). Using the examples in the sample rc file in the totport code's <code>t/</code> subdir, you might say:</p>
<pre><code>totp -u alice ports = GIT1,GIT2,MAIL</code></pre>
<p>which would allow alice to access those internal host:port combinations.</p>
<p>NOTE the spaces around the &quot;=&quot; are <em>required</em>. ALSO NOTE there are NO spaces between the various shortnames used, just a comma.</p></li>
<li><p>Run <code>totport rebuild</code> to rebuild <code>~/.ssh/authorized_keys</code>.</p></li>
<li><p>Tell the user she can &quot;enroll&quot;. She has to use a normal ssh client and run <code>ssh totport@host enroll</code>.</p>
<p>This will print a &quot;secret&quot; that she will need to feed to the TOTP app (FreeOTP preferred, else &quot;Google Authenticator&quot;) on the user's Android mobile or tab. See one of the appendices for more on this part of the process.</p></li>
</ol>
<h1 id="details"><span class="header-section-number">3</span> details</h1>
<h2 id="token-validity-and-expiry"><span class="header-section-number">3.1</span> token validity and expiry</h2>
<p>Once a valid authcode has been submitted, the next connection to the same user/server (<code>totport@host</code>), with the port forward options specified, should be sent within 20 minutes. After 20 minutes, the entry could be purged and the auth keys file rebuilt at any time.</p>
<p>You can change this on a per-user basis. For example, Bob always comes in from the same IP so we want to make things easier for him. This command will keep the IP valid for 10 hours:</p>
<pre><code>totp -u &lt;username&gt; valid_for = 600</code></pre>
<p>Although there's no daemon hanging around waiting for entries to expire and rebuild the authkeys file, a rebuild can be triggered in the following ways:</p>
<ul>
<li><p>Manually running <code>totport rebuild</code>. You could also put it in cron. I suggest using an interval between 10 minutes and 1 hour.</p></li>
<li><p>Any time anyone tries to validate themselves. This is kind of a hack, in that if you forget to set up a cron job, there's still <em>some</em> way in which expired entries get purged!</p>
<p>On the other hand, it causes interesting behaviour in some vague &quot;game theory&quot; sense -- the busier the system, the more actively things get cleaned up and people have to revalidate themselves!</p></li>
</ul>
<p>If the &quot;people have to revalidate themselves&quot; bothers you, please remember that this is only a port forward, and as long as your network does not die, an <code>ssh -fN ...</code> should basically just run forever.</p>
<h1 id="background"><span class="header-section-number">4</span> background</h1>
<p>There are several background bits you might need, in order to understand how this works.</p>
<ol style="list-style-type: decimal">
<li><p>How does ssh force something specific to run, is best explained <a href="http://gitolite.com/gitolite/glssh.html">here</a>. Some parts of that page may be specific to gitolite, but by and large it's a fairly general explanation of ssh's &quot;force command&quot; feature.</p>
<p>That page also coveres how ssh distinguishes one user from another, if you noticed that <em>every user</em> must ssh to the same ssh user (<code>totport</code> in our examples) and were wondering how that happens.</p></li>
<li><p>Ssh's authorized_keys file has more tricks than described in the link given in the previous para. Read up on the &quot;from&quot; and &quot;permitopen&quot; options.</p></li>
<li><p>Ssh port forwarding is important to understand. Briefly, what happens when you say</p>
<pre><code>ssh -L 2222:1.2.3.4:22 user@host</code></pre>
<p>is that a local listening port (2222) is created on your workstation. Any connections to this will be transparently forwarded <em>over the secure channel</em> to the server, and a connection is opened to the remote host and port specified (in this example, IP 1.2.3.4, port 22).</p>
<p>One advantage of this is that the IP used is <strong>as seen by the TOTP server</strong>, which means you can reach internal servers.</p></li>
<li><p>TOTP is also useful to know. For example, you (and your users, even more so!) need to understand that the secret that was generated by the TOTP system must <strong>NOT</strong> be stored permanently on the same computer that contains the ssh private key! Then it would not really be &quot;2 factor&quot;, in a sense.</p>
<p>Several websites, starting with google itself, then github, and many more, use TOTP based 2-factor auth. Many of those services have explanations, pictures, etc., of TOTP. Search around...</p></li>
</ol>
<h1 id="security-notes"><span class="header-section-number">5</span> SECURITY NOTES</h1>
<p>Mainly, if your users don't protect the &quot;secret&quot; well enough, this won't work so well. Luckily, both FreeOTP and &quot;google authenticator&quot; don't allow you to view the secret once it has been entered, so it's safe from casual attempts at getting the secret, but I have no idea what the internal storage is and if some fancy tool/hardware/memory extractor can lift that information out.</p>
<p>If your private key is only used for this site, this kinda sorta makes it less risky to not have a passphrase on it, but for really important sites I still would do that.</p>
<h2 id="todo"><span class="header-section-number">5.1</span> TODO</h2>
<p><strong>Brute force/DOS protection</strong></p>
<p>Since the attack model is of someone having successfully compromised one of your users' ssh private key, you can't implicitly trust them. It should be easy enough to add code that detects more than N logins in M seconds, and if that happens, disable all access to that user for some time.</p>
<h1 id="appendices"><span class="header-section-number">6</span> Appendices</h1>
<h2 id="user-ssh-keys"><span class="header-section-number">6.1</span> (user) ssh keys</h2>
<p>Generating ssh keys and sending your admin the public key is fairly straightforward. Steps 1, 2, and parts of step 4 in <a href="https://help.github.com/articles/generating-ssh-keys">Github's help pages</a> are useful here.</p>
<h2 id="user-securely-downloading-the-totp-secret"><span class="header-section-number">6.2</span> (user) securely downloading the TOTP &quot;secret&quot;</h2>
<p>First, let's remind ourselves that the TOTP authcode must come from a <strong>different device</strong> than the PC which contains your ssh keypair. Although it is quite easy to do that also on the same box, it is <span class="red"><strong>most strongly recommended not to do so</strong></span>. In fact, don't even be tempted to <strong>store</strong> the secret on the same computer!</p>
<p>However, the initial enrollment will happen from your computer. When you type in the 'ssh totport@host enroll' command, you will get a summary of the different ways to get that code <strong>securely</strong> into your device.</p>
<p>This section gives you more details. Please use any of those methods, each of which has been detailed in the three sub-sections below. Please do <em>not</em> use google.com's QR code service, or indeed <em>any</em> external server, to produce the QR code.</p>
<p><span class="gray">I would also avoid Windows programs to generate QR codes. As far as I know there's no curated, trusted, repository to get software from, like there is for most Linux distros. Often it's hard to even know if the software is open source. Worse, even <a href="http://www.osnews.com/story/24934/VLC_Suffers_from_Companies_Spreading_Malware_Bundled_with_VLC">well-known, credible, open source software can be riddled with malware</a> because of unscrupulous people taking advantage of the lack of a trusted repository.</span></p>
<p><span class="red"><strong>IMPORTANT</strong></span>: don't do this from a location where your laptop or desktop screen is visible to other people, in case someone captures your screen with a good camera from a distance! Not only are cell phone cameras getting better and better, qrcode is <em>designed</em> to overcome many errors!</p>
<h3 id="option-1-qr-code-server-on-the-totp-box"><span class="header-section-number">6.2.1</span> option 1: qr code server on the TOTP box</h3>
<p>The totp box also runs a qr code web server called <code>qrserve</code>. This server already has your &quot;secret&quot;, and <code>qrserve</code> can only be accessed over the secure channel you're already talking on, so this is as safe as it gets.</p>
<p>On Linux, run ssh with <code>-L 3536:127.0.0.1:3536</code> option, and the command <code>qrcode</code> to setup the port forward required. That is:</p>
<pre><code>ssh -L 3536:127.0.0.1:3536 -p &lt;port&gt; totport@&lt;IP&gt; qrcode</code></pre>
<p>where &quot;&lt;port&gt;&quot; and &quot;&lt;IP&gt;&quot; are whatever your admin gave you.</p>
<p>On Windows, you'll have to do the equivalent in putty. I'm not really sure how to do this right now, but I'll update this when I find out. I believe it involves a related command called &quot;plink&quot;.</p>
<p>After that command starts, <span class="red"><strong>open a &quot;private window&quot; in your browser</strong></span> <span class="gray">(some browsers call it &quot;incognito&quot; mode)</span>, then point it at the url that the enroll command printed, which is something like:</p>
<pre><code>http://127.0.0.1:3536/qr/....</code></pre>
<p>A qrcode image should show up. Use your device's QR code scanner to scan it. (Please note that the FreeOTP app comes with a builtin scanner).</p>
<p>When done, hit Ctrl-C on the ssh command above or close the putty session.</p>
<h3 id="option-2-qrencode-command"><span class="header-section-number">6.2.2</span> option 2: qrencode command</h3>
<p>On Linux etc., install 'qrencode' using your package manager and run the qrencode command that the enroll output showed. This command should look something like this:</p>
<pre><code>qrencode -tANSI -m1 -o- otpauth://totp/....?secret=....</code></pre>
<p>A qrcode image should show up. Use your device's QR code scanner to scan it. (Please note that the FreeOTP app comes with a builtin scanner).</p>
<p><span class="red"><strong>Please make sure your shell does not retain the command in its command history!</strong></span> If you don't have a ready-to-hand way of ensuring that, run <code>cat | sh</code> then paste that line in and hit Ctrl-D!</p>
<h3 id="option-3-type-it-in"><span class="header-section-number">6.2.3</span> option 3: type it in!</h3>
<p>If all else fails, just type in the secret. Spaces and case differences do not matter, and the enroll command conveniently prints it in chunks of 4 letters to make it a little easier on your eyes!</p>
<h2 id="user-setting-up-ssh-config"><span class="header-section-number">6.3</span> (user) setting up ssh config</h2>
<p>Let's say you need the following port forwards: port 22 of host 1.2.3.4, port 443 of host 1.2.3.5, and port 5432 (postgres) on host 1.2.3.6.</p>
<p>Once the enrollment is done, here's what you will be doing whenever you wish to connect with any of these services:</p>
<pre><code>ssh totport@totp-gatekeeper.example.com val &lt;TOTP code&gt;
# validate your IP, then:
ssh -L 2222:1.2.3.4:22 -L 4433:1.2.3.5:443 -L 5432:1.2.3.6:5432 totport@totp-gatekeeper.example.com</code></pre>
<p>That's a terrible thing to have to type every time! After a few days you'd feel like you'd get CTS or something!</p>
<p>Luckily, ssh is pretty smart. Just create a file called &quot;config&quot; in <code>~/.ssh</code>, and put these lines in it:</p>
<pre><code>host tp
    user totport
    hostname totp-gatekeeper.example.com
    # ssh to 1.2.3.4
    localforward    localhost:2222          1.2.3.4:22
    # https to 1.2.3.5
    localforward    localhost:4433          1.2.3.5:443
    # postgres server on 1.2.3.6
    localforward    localhost:5432          1.2.3.6:5432</code></pre>
<p>And that's it. Now you can simply type:</p>
<pre><code>ssh tp val &lt;TOTP code&gt;
# and then...
ssh tp</code></pre>
<p>and once you type the second command, your local ports are ready to use. In order to &quot;ssh 1.2.3.4&quot;, you'd say &quot;ssh -p 2222 127.0.0.1&quot; instead. Similarly, instead of &quot;https://1.2.3.5&quot;, you'd say &quot;https://127.0.0.1:4433&quot;, and so on.</p>
<h2 id="user-putty"><span class="header-section-number">6.4</span> (user) putty</h2>
<p>I've been told that all this can be done in putty also, but it's cumbersome. The preferences dialog is a steaming pile of canine excrement, but with great care, patience, experience, (and large amounts of alcohol, in the worst case), it is possible to set it up in a way similar to openssh's ssh config file.</p>
<p>Patches to this section of the documentation are NOT welcome. However, if you put up instructions somewhere or find a good place that describes how to do the equivalent of the previous section, email me and I'd be happy to add a link to it.</p>
<h2 id="admin-users-with-more-than-one-ssh-key"><span class="header-section-number">6.5</span> (admin) users with more than one ssh key</h2>
<p>Unlike gitolite, totport has no simple way to let a single user use multiple keys. Just treat them as different users &quot;alice-1&quot;, &quot;alice-2&quot;, etc., or perhaps &quot;alice-home&quot;, &quot;alice-work&quot;, &quot;alice-laptop&quot;, and so on. An added advantage of this is that you can choose different port permissions for the different personas, if needed.</p>
<p>There are probably ways to deal with this better, but until it becomes a serious issue this workaround will do fine.</p>
<hr />
<p><code>totport</code> is copyright Sitaram Chamarty and is licensed under the GPL v2.</p>
</body>
</html>
